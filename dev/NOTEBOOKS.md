# MolSys-AI â€“ Notebook Integration Guide

This document explains how to use MolSys-AI from inside Jupyter notebooks
(JupyterLab today, potentially VS Code notebooks in the future).

The goal is to provide:

- a **safe baseline** that never modifies the active notebook, and
- a path towards more powerful features (such as inserting cells) that are
  explicitly opt-in and will be implemented later.

For the overarching design, see `dev/decisions/ADR-013.md`.

## 1. Basic chat from a notebook

Helpers live in `client/agent/notebook.py`:

- `create_notebook_agent(server_url: str | None = None, use_planner: bool = True)`
- `NotebookChatSession`

Example usage:

```python
from agent.notebook import create_notebook_agent, NotebookChatSession

# Create an agent that talks to the internal engine server
agent = create_notebook_agent()  # uses MOLSYS_AI_ENGINE_URL or http://127.0.0.1:8001

session = NotebookChatSession(agent=agent)

reply = session.ask("How do I load a system in MolSysMT?")
print(reply)
```

The session keeps an internal history (`messages`) so each `ask()` call has
access to previous turns. The agent uses:

- the `SimplePlanner` to decide whether to use RAG for documentation-style
  questions,
- the `ModelClient` configured by `create_notebook_agent`.

## 2. Generating new workflow notebooks (safe path)

For workflows that go beyond a single reply (e.g. multi-step analyses using
MolSysMT, TopoMT, MolSysViewer), the recommended pattern is:

1. Let MolSys-AI propose a workflow.
2. Represent that workflow as a sequence of notebook cells.
3. Write a new `.ipynb` file to disk.
4. Open and execute the new notebook manually.

The helpers in `client/agent/notebook.py` provide:

- `NotebookCellSpec(cell_type: str, source: str)`
- `create_workflow_notebook(cells, output_path) -> Path`

Example:

```python
from agent.notebook import NotebookCellSpec, create_workflow_notebook

cells = [
    NotebookCellSpec(
        "markdown",
        "# Pocket analysis workflow for PDB 1TCD\n"
        "This notebook was generated by MolSys-AI.\n",
    ),
    NotebookCellSpec(
        "code",
        "import molsysmt as msm\n"
        "import topomt\n"
        "# TODO: add pocket detection code here\n",
    ),
]

path = create_workflow_notebook(cells, "workflow_1tcd_pockets.ipynb")
print(f"New workflow notebook written to: {path}")
```

Key properties:

- The current notebook is **not** modified.
- The generated notebook is a standard Jupyter notebook (nbformat 4) that can
  be opened and executed in JupyterLab, VS Code, etc.

This is the **recommended approach** for initial integration and for most
production use cases.

## 3. In-place editing (placeholder, advanced)

There is a placeholder function in `client/agent/notebook.py`:

- `inject_workflow_into_current_notebook(*args, **kwargs) -> None`

At the moment this function raises `NotImplementedError` and exists only as a
marker for future work. The intent is:

- In JupyterLab (and later VS Code), provide an **opt-in** mechanism to:
  - insert new cells into the current notebook,
  - annotate them as AI-generated,
  - allow easy inspection and edits by the user.
- Never execute code automatically without explicit user action.

Until this integration is designed and implemented (likely using front-end
APIs rather than pure Python), **do not rely on it for any functionality**.

## 4. Recommended patterns

- For **interactive Q&A**:
  - Use `NotebookChatSession` and print or render the replies inline.

- For **non-trivial workflows** (e.g. multi-step MolSysMT/TopoMT/MolSysViewer
  pipelines):
  - Let MolSys-AI return a structured representation of the workflow.
  - Translate it into `NotebookCellSpec` objects.
  - Use `create_workflow_notebook` to generate a new notebook.
  - Review and execute that notebook manually.

- For **future advanced features** (once implemented):
  - Use dedicated UI controls or explicit helpers to insert AI-generated cells
    into the current notebook, with clear visual cues and the ability to undo.

## 5. Next steps

Future work around notebook integration may include:

- Defining a small internal DSL or schema for workflow descriptions that the
  planner/executor can emit and that can be converted to notebook cells.
- Creating example notebooks under `train/notebooks/` or `dev/` that showcase:
  - interactive chat,
  - automatic workflow notebook generation for real MolSys* tasks.
- Experimenting with JupyterLab/VS Code APIs to implement a safe and
  auditable `inject_workflow_into_current_notebook` for advanced users.
